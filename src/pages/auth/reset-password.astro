---
import AuthLayout from "../../layouts/AuthLayout.astro";
import { ResetPasswordForm } from "../../components/auth/ResetPasswordForm";
import { requireNoAuth } from "../../lib/utils/auth-guard";

export const prerender = false;

// Check if user is already logged in
requireNoAuth(Astro);

// Get the reset token from URL params (supports both PKCE and token_hash flows)
const code = Astro.url.searchParams.get("code");
const tokenHash = Astro.url.searchParams.get("token_hash");
const type = Astro.url.searchParams.get("type");

// If no code or token_hash provided, redirect to login
if (!code && !tokenHash) {
  return Astro.redirect("/auth/login?error=invalid-reset-link");
}

const title = "Ustaw nowe hasło - VibeTravels";
---

<AuthLayout title={title}>
  <ResetPasswordForm client:load code={code} tokenHash={tokenHash} type={type} />

  <div slot="footer">
    Pamiętasz hasło?
    <a href="/auth/login" class="font-medium text-primary hover:underline">Zaloguj się</a>
  </div>
</AuthLayout>
